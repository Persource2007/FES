openapi: 3.0.3
info:
  title: FES Stories API
  description: |
    API documentation for FES Stories application.
    
    This API provides endpoints for authentication, health checks, user management, activity tracking, story categories, and story management.
    
    **Base URL:** `http://localhost:8000`
    
    **Authentication:** 
    - **OAuth 2.0 with PKCE:** Uses Backend-for-Frontend (BFF) pattern for secure token management
    - **Session-based:** Protected endpoints require HTTP-only `session_id` cookie
    - **Public endpoints:** Health check, regions, published stories, and categories are publicly accessible
    - **Token refresh:** Automatic token refresh within 5-minute threshold before expiration
    
    **Activity Tracking:** All user activities are logged to the database. Users can only view their own activities.
    
    **Story Management:** 
    - Writers can submit stories for review
    - Editors can review, approve, reject, and edit stories from their organization
    - Super admins can review, approve, reject, edit, and delete all stories
    - Published stories are available via public endpoint
  version: 1.0.0
  contact:
    name: FES Stories API Support
    email: support@fesstories.com
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.fesstories.com
    description: Production server (when available)

tags:
  - name: Health
    description: Health check and system status endpoints
  - name: Authentication
    description: User authentication endpoints
  - name: Users
    description: User management endpoints (Super admin only)
  - name: Activities
    description: User activity logging and retrieval endpoints
  - name: Regions
    description: Region management endpoints
  - name: Organizations
    description: Organization management endpoints (Super admin only)
  - name: Story Categories
    description: Story category management and writer access control endpoints (Super admin and Editors)
  - name: Stories
    description: Story submission, review, and publishing endpoints

paths:
  /api/health:
    get:
      tags:
        - Health
      summary: Health Check
      description: |
        Verifies the API server status and database connectivity.
        
        Returns:
        - Database connection status
        - User count in database
        - Database name
        - Timestamp
      operationId: healthCheck
      responses:
        '200':
          description: Database connection successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckSuccess'
              example:
                success: true
                message: "Database connection successful"
                user_count: 2
                database: "fes_stories"
                timestamp: "2025-12-01T12:00:00+00:00"
        '500':
          description: Database connection failed or server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthCheckError'
              example:
                success: false
                message: "Database connection failed: Connection refused"
                user_count: 0
                database: "fes_stories"
                timestamp: "2025-12-01T12:00:00+00:00"
                error:
                  code: 2002
                  message: "Connection refused"

  /api/auth/login:
    post:
      tags:
        - Authentication
      summary: User Login
      description: |
        Authenticates a user with email and password.
        
        **Note:** Currently uses simplified validation (checks if user exists).
        Password verification is disabled for development.
        
        **Test Credentials:**
        - Email: `vyom@example.com`, Password: `123`
        - Email: `krina@example.com`, Password: `123`
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              validLogin:
                summary: Valid login credentials
                value:
                  email: "vyom@example.com"
                  password: "123"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginSuccess'
              example:
                success: true
                message: "Login successful"
                user:
                  id: 1
                  email: "vyom@example.com"
                  name: "Vyom"
                  role:
                    id: 1
                    name: "Super admin"
        '400':
          description: Validation error - Invalid request data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                success: false
                message: "Validation failed"
                errors:
                  email:
                    - "The email must be a valid email address."
                  password:
                    - "The password field is required."
        '401':
          description: Invalid credentials - User not found or password incorrect
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Invalid credentials"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred during login"

  /api/auth/oauth/callback:
    post:
      tags:
        - Authentication
      summary: OAuth Callback (BFF)
      description: |
        Handles OAuth 2.0 authorization code exchange via Backend-for-Frontend (BFF) pattern.
        
        **Flow:**
        1. Frontend receives authorization code from OAuth server
        2. Frontend sends code and code_verifier to this BFF endpoint
        3. BFF exchanges code for tokens with OAuth server
        4. BFF fetches user info from OAuth server
        5. BFF creates/updates local user record
        6. BFF creates server-side session with encrypted tokens
        7. BFF returns HTTP-only cookie with session_id
        
        **Security:** Tokens are stored server-side in encrypted database, never exposed to client
      operationId: oauthCallback
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OAuthCallbackRequest'
            examples:
              validCallback:
                summary: Valid OAuth callback
                value:
                  code: "abc123def456"
                  code_verifier: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"
      responses:
        '200':
          description: OAuth login successful
          headers:
            Set-Cookie:
              description: HTTP-only session cookie
              schema:
                type: string
                example: "session_id=abc123def456; Path=/; HttpOnly; SameSite=Lax"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OAuthCallbackSuccess'
              example:
                success: true
                message: "Login successful"
                user:
                  id: 1
                  name: "John Doe"
                  email: "john@example.com"
                  role:
                    id: 1
                    name: "Super admin"
        '400':
          description: Validation error or invalid authorization code
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Invalid authorization code"
        '401':
          description: User not found or no role assigned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "User not found in database. Please contact the administrator to create an account for you."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred during authentication"

  /api/auth/me:
    get:
      tags:
        - Authentication
      summary: Get Current User (BFF)
      description: |
        Retrieves the current authenticated user from the session cookie.
        
        **Authentication:** Requires valid `session_id` HTTP-only cookie
        
        **Flow:**
        1. Client sends request with session_id cookie
        2. BFF validates session cookie
        3. BFF checks session expiration
        4. BFF returns user data with role information
        
        **Token Refresh:** Automatically refreshes tokens if they are about to expire (within 5 minutes)
      operationId: getCurrentUser
      security:
        - cookieAuth: []
      responses:
        '200':
          description: User retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetCurrentUserSuccess'
              example:
                success: true
                user:
                  id: 1
                  name: "John Doe"
                  email: "john@example.com"
                  role:
                    id: 1
                    name: "Super admin"
        '401':
          description: No active session or session expired
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "No active session"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while retrieving user"

  /api/auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout (BFF)
      description: |
        Logs out the current user by destroying the server-side session.
        
        **Flow:**
        1. Client sends logout request with session_id cookie
        2. BFF deletes session from database
        3. BFF expires session cookie
        4. Client clears localStorage
        
        **Security:** Session is permanently deleted from database, cannot be reused
      operationId: logout
      security:
        - cookieAuth: []
      responses:
        '200':
          description: Logout successful
          headers:
            Set-Cookie:
              description: Expired session cookie
              schema:
                type: string
                example: "session_id=; Path=/; HttpOnly; SameSite=Lax; Expires=Thu, 01 Jan 1970 00:00:00 GMT"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LogoutSuccess'
              example:
                success: true
                message: "Logged out successfully"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred during logout"

  /api/users:
    get:
      tags:
        - Users
      summary: List Users
      description: |
        Get all users excluding Super admin users.
        
        **Access:** Super admin only
        
        Returns a list of all users with their roles (excluding Super admin).
      operationId: listUsers
      responses:
        '200':
          description: Users retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserListResponse'
              example:
                success: true
                users:
                  - id: 2
                    name: "John Doe"
                    email: "john@example.com"
                    role_id: 2
                    role_name: "Writer"
                    created_at: "2025-12-01T10:00:00+00:00"
                    updated_at: "2025-12-01T10:00:00+00:00"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while fetching users"

    post:
      tags:
        - Users
      summary: Create User
      description: |
        Create a new user with the specified role.
        
        **Access:** Super admin only
        
        **Restrictions:**
        - Cannot create Super admin users
        - Email must be unique
      operationId: createUser
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateUserRequest'
            example:
              name: "Jane Doe"
              email: "jane@example.com"
              password: "password123"
              role_id: 2
              organization_id: 1
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateUserResponse'
              example:
                success: true
                message: "User created successfully"
                user:
                  id: 3
                  name: "Jane Doe"
                  email: "jane@example.com"
                  role_id: 2
                  role_name: "Writer"
                  created_at: "2025-12-01T12:00:00+00:00"
                  updated_at: "2025-12-01T12:00:00+00:00"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                success: false
                message: "Validation failed"
                errors:
                  email:
                    - "The email has already been taken."
                  role_id:
                    - "The selected role id is invalid."
        '403':
          description: Forbidden - Cannot create Super admin user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Cannot create Super admin user"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while creating user"

  /api/users/roles:
    get:
      tags:
        - Users
      summary: Get Available Roles
      description: |
        Get all available roles excluding Super admin.
        
        **Access:** Super admin only
        
        Returns a list of roles that can be assigned to users.
      operationId: getRoles
      responses:
        '200':
          description: Roles retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RoleListResponse'
              example:
                success: true
                roles:
                  - id: 2
                    role_name: "Writer"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while fetching roles"

  /api/users/{id}/role:
    put:
      tags:
        - Users
      summary: Update User Role
      description: |
        Update the role of a specific user.
        
        **Access:** Super admin only
        
        **Restrictions:**
        - Cannot modify Super admin users
        - Cannot assign Super admin role
      operationId: updateUserRole
      parameters:
        - name: id
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            format: int64
          example: 2
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateRoleRequest'
            example:
              name: "John Doe"
              email: "john@example.com"
              role_id: 2
              organization_id: 1
      responses:
        '200':
          description: User role updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateRoleResponse'
              example:
                success: true
                message: "User role updated successfully"
                user:
                  id: 2
                  name: "John Doe"
                  email: "john@example.com"
                  role_id: 2
                  role_name: "Writer"
                  created_at: "2025-12-01T10:00:00+00:00"
                  updated_at: "2025-12-01T12:00:00+00:00"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                success: false
                message: "Validation failed"
                errors:
                  role_id:
                    - "The selected role id is invalid."
        '403':
          description: Forbidden - Cannot modify Super admin or assign Super admin role
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Cannot modify Super admin user"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "User not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while updating user role"

  /api/users/{id}/toggle-status:
    patch:
      tags:
        - Users
      summary: Toggle User Active Status
      description: |
        Toggle the active/inactive status of a user.
        
        **Access:** Super admin only
        
        **Restrictions:**
        - Cannot toggle Super admin users
        - Toggles between active (true) and inactive (false)
      operationId: toggleUserStatus
      parameters:
        - name: id
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            format: int64
          example: 2
      responses:
        '200':
          description: User status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToggleUserStatusResponse'
              example:
                success: true
                message: "User status updated successfully"
                user:
                  id: 2
                  name: "John Doe"
                  email: "john@example.com"
                  role_id: 2
                  role_name: "Writer"
                  is_active: false
                  created_at: "2025-12-01T10:00:00+00:00"
                  updated_at: "2025-12-02T12:00:00+00:00"
        '403':
          description: Forbidden - Cannot toggle Super admin user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Cannot deactivate Super admin user"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "User not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while toggling user status"

  /api/users/{id}:
    delete:
      tags:
        - Users
      summary: Delete User
      description: |
        Delete a specific user.
        
        **Access:** Super admin only
        
        **Restrictions:**
        - Cannot delete Super admin users
      operationId: deleteUser
      parameters:
        - name: id
          in: path
          required: true
          description: User ID
          schema:
            type: integer
            format: int64
          example: 2
      responses:
        '200':
          description: User deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteUserResponse'
              example:
                success: true
                message: "User deleted successfully"
        '403':
          description: Forbidden - Cannot delete Super admin user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Cannot delete Super admin user"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "User not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while deleting user"

  /api/organizations:
    get:
      tags:
        - Organizations
      summary: Get all organizations
      description: |
        Retrieves all organizations.
        
        **Access:** Super admin only
        
        Returns a list of all organizations with their details.
      operationId: getOrganizations
      responses:
        '200':
          description: Successfully retrieved organizations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrganizationListResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Organizations
      summary: Create a new organization
      description: |
        Creates a new organization.
        
        **Access:** Super admin only
      operationId: createOrganization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '201':
          description: Organization created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateOrganizationResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/organizations/{id}:
    put:
      tags:
        - Organizations
      summary: Update an organization
      description: |
        Updates an existing organization.
        
        **Access:** Super admin only
      operationId: updateOrganization
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Organization ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationRequest'
      responses:
        '200':
          description: Organization updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateOrganizationResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Organizations
      summary: Delete an organization
      description: |
        Deletes an organization.
        
        **Access:** Super admin only
      operationId: deleteOrganization
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Organization ID
          example: 1
      responses:
        '200':
          description: Organization deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteOrganizationResponse'
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/organizations/{id}/toggle-status:
    patch:
      tags:
        - Organizations
      summary: Toggle Organization Active Status
      description: |
        Toggle the active/inactive status of an organization.
        
        **Access:** Super admin only
        
        Toggles between active (true) and inactive (false).
      operationId: toggleOrganizationStatus
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Organization ID
          example: 1
      responses:
        '200':
          description: Organization status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToggleOrganizationStatusResponse'
        '404':
          description: Organization not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/regions:
    get:
      tags:
        - Regions
      summary: Get all regions
      description: |
        Retrieves all active regions (Indian states and union territories).
        
        **Access:** Available to all authenticated users
        
        Returns a list of all regions with their names and codes.
      operationId: getRegions
      responses:
        '200':
          description: Successfully retrieved regions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RegionListResponse'
              example:
                success: true
                regions:
                  - id: 1
                    name: "Andhra Pradesh"
                    code: "AP"
                    is_active: true
                    created_at: "2025-12-02T10:00:00+00:00"
                    updated_at: "2025-12-02T10:00:00+00:00"
                  - id: 2
                    name: "Arunachal Pradesh"
                    code: "AR"
                    is_active: true
                    created_at: "2025-12-02T10:00:00+00:00"
                    updated_at: "2025-12-02T10:00:00+00:00"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while fetching regions"

  /api/activities:
    get:
      tags:
        - Activities
      summary: Get User Activities
      description: |
        Get all activities for the current user.
        
        **Access:** Authenticated users only
        
        **Security:**
        - Users can only see their own activities
        - Activities are filtered by user_id parameter
        
        Returns the last 50 activities for the specified user, ordered by most recent first.
      operationId: getActivities
      parameters:
        - name: user_id
          in: query
          required: true
          description: User ID to retrieve activities for
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        '200':
          description: Activities retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityListResponse'
              example:
                success: true
                activities:
                  - id: 1
                    type: "login"
                    message: "Logged in as Vyom (vyom@example.com)"
                    metadata:
                      userId: 1
                      userName: "Vyom"
                      userEmail: "vyom@example.com"
                      roleName: "Super admin"
                    timestamp: "2025-12-02T10:30:00+00:00"
                  - id: 2
                    type: "create"
                    message: "Created new user: John Doe (john@example.com) with role: Writer"
                    metadata:
                      userEmail: "john@example.com"
                      userName: "John Doe"
                      roleName: "Writer"
                    timestamp: "2025-12-02T10:25:00+00:00"
        '400':
          description: Validation error - Invalid user_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                success: false
                message: "Validation failed"
                errors:
                  user_id:
                    - "The user id field is required."
                    - "The selected user id is invalid."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while fetching activities"

    post:
      tags:
        - Activities
      summary: Log Activity
      description: |
        Create a new activity log entry for the current user.
        
        **Access:** Authenticated users only
        
        **Activity Types:**
        - `login` - User login events
        - `create` - User creation events
        - `edit` - User role update events
        - `delete` - User deletion events
        
        The metadata field can contain additional information about the activity in JSON format.
      operationId: logActivity
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateActivityRequest'
            example:
              user_id: 1
              type: "login"
              message: "Logged in as Vyom (vyom@example.com)"
              metadata:
                userId: 1
                userName: "Vyom"
                userEmail: "vyom@example.com"
                roleName: "Super admin"
      responses:
        '201':
          description: Activity logged successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateActivityResponse'
              example:
                success: true
                message: "Activity logged successfully"
                activity:
                  id: 1
                  type: "login"
                  message: "Logged in as Vyom (vyom@example.com)"
                  metadata:
                    userId: 1
                    userName: "Vyom"
                    userEmail: "vyom@example.com"
                    roleName: "Super admin"
                  timestamp: "2025-12-02T10:30:00+00:00"
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
              example:
                success: false
                message: "Validation failed"
                errors:
                  user_id:
                    - "The user id field is required."
                    - "The selected user id is invalid."
                  type:
                    - "The type field is required."
                    - "The type may not be greater than 50 characters."
                  message:
                    - "The message field is required."
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while logging activity"

  /api/story-categories:
    get:
      tags:
        - Story Categories
      summary: Get all story categories
      description: |
        Retrieves all story categories. 
        
        **Access:** 
        - Super admins see all categories
        - Editors see only categories from their organization
        - Writers see only categories accessible to their organization
        
        **Query Parameters:**
        - `user_id` (optional): User ID for organization-based filtering
      operationId: getStoryCategories
      parameters:
        - name: user_id
          in: query
          required: false
          description: User ID for organization-based filtering (required for Editors)
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        '200':
          description: Successfully retrieved categories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryCategoryListResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Story Categories
      summary: Create a new story category
      description: |
        Creates a new story category. 
        
        **Access:** 
        - Super admin: Can assign to any organizations
        - Editor: Automatically assigned to their organization only
        
        **Note:** Categories are now assigned to organizations instead of regions.
      operationId: createStoryCategory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoryCategoryRequest'
            example:
              name: "Technology"
              description: "Stories about technology and innovation"
              is_active: true
              organization_ids: [1, 2]
              user_id: 1
      responses:
        '201':
          description: Category created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateStoryCategoryResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/story-categories/{id}:
    put:
      tags:
        - Story Categories
      summary: Update a story category
      description: |
        Updates an existing story category.
        
        **Access:** 
        - Super admin: Can update any category and change organization assignments
        - Editor: Can only update categories from their organization, cannot change organization assignment
        
        **Note:** Categories are now assigned to organizations instead of regions.
      operationId: updateStoryCategory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Category ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateStoryCategoryRequest'
            example:
              name: "Technology and Innovation"
              description: "Updated description"
              is_active: true
              organization_ids: [1, 2]
              user_id: 1
      responses:
        '200':
          description: Category updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateStoryCategoryResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/story-categories/{id}/toggle-status:
    patch:
      tags:
        - Story Categories
      summary: Toggle Category Active Status
      description: |
        Toggle the active/inactive status of a story category.
        
        **Access:** Super admin only
        
        Toggles between active (true) and inactive (false).
      operationId: toggleCategoryStatus
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Category ID
          example: 1
      responses:
        '200':
          description: Category status updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ToggleCategoryStatusResponse'
              example:
                success: true
                message: "Category status updated successfully"
                category:
                  id: 1
                  name: "Technology"
                  description: "Stories about technology"
                  is_active: false
                  created_at: "2025-12-02T10:00:00+00:00"
                  updated_at: "2025-12-02T12:00:00+00:00"
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Story category not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "An error occurred while toggling category status"

    delete:
      tags:
        - Story Categories
      summary: Delete a story category
      description: |
        Deletes a story category. **Super admin only.**
        This will also remove all reader access to this category.
      operationId: deleteStoryCategory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Category ID
          example: 1
      responses:
        '200':
          description: Category deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteStoryCategoryResponse'
        '404':
          description: Category not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/story-categories/writers:
    get:
      tags:
        - Story Categories
      summary: Get all writers with their category access
      description: |
        Retrieves all writers with their assigned category access. **Super admin only.**
        
        **Note:** "Reader" role has been renamed to "Writer".
      operationId: getWritersWithAccess
      responses:
        '200':
          description: Successfully retrieved readers with access
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReadersWithAccessResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/story-categories/writers/{userId}:
    get:
      tags:
        - Story Categories
      summary: Get categories accessible by a writer
      description: |
        Retrieves all categories that a specific writer has access to.
        
        **Note:** Writers can only access categories assigned to their organization.
        "Reader" role has been renamed to "Writer".
      operationId: getWriterCategories
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Reader user ID
          example: 2
      responses:
        '200':
          description: Successfully retrieved reader categories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StoryCategoryListResponse'
        '403':
          description: User is not a reader
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/story-categories/writers/{userId}/access:
    put:
      tags:
        - Story Categories
      summary: Update writer access to categories
      description: |
        Updates which categories a writer can post stories to. **Super admin only.**
        This replaces all existing access with the provided category IDs.
        
        **Note:** "Reader" role has been renamed to "Writer".
      operationId: updateWriterAccess
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Reader user ID
          example: 2
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateReaderAccessRequest'
            example:
              category_ids: [1, 2, 3]
      responses:
        '200':
          description: Reader access updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateReaderAccessResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '403':
          description: User is not a reader
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/published:
    get:
      tags:
        - Stories
      summary: Get all published stories (Public)
      description: |
        Retrieves all published stories. This is a public endpoint and does not require authentication.
        
        Returns stories ordered by publication date (newest first).
      operationId: getPublishedStories
      responses:
        '200':
          description: Successfully retrieved published stories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PublishedStoriesResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories:
    post:
      tags:
        - Stories
      summary: Submit a new story (Writer only)
      description: |
        Submits a new story for review. **Writer only.**
        
        **Requirements:**
        - User must have `post_stories` permission
        - User must be a Writer role
        - User must have access to the selected category (through their organization)
        - Category must be active
        
        Story will be created with status `pending` and requires admin/editor approval.
        
        **Note:** "Reader" role has been renamed to "Writer".
      operationId: submitStory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SubmitStoryRequest'
            example:
              user_id: 2
              category_id: 1
              title: "Saving the western ghats forest"
              subtitle: "A community's fight for conservation"
              photo_url: "https://example.com/images/story-photo.jpg"
              quote: "We must protect our forests for future generations"
              person_name: "Rajesh Kumar"
              person_location: "Mumbai, Maharashtra"
              facilitator_name: "Dr. Priya Sharma"
              facilitator_organization: "FES Foundation"
              state: "Maharashtra"
              city: "Mumbai"
              content: "A tribal community's fight to protect their ancestral woodland from commercial logging."
      responses:
        '201':
          description: Story submitted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SubmitStoryResponse'
        '400':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '403':
          description: Forbidden - User doesn't have permission or category access
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Category not found or inactive
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/pending:
    get:
      tags:
        - Stories
      summary: Get pending stories for review
      description: |
        Retrieves all stories with status `pending` awaiting review.
        
        **Access:** 
        - Super admin: Sees all pending stories
        - Editor: Sees only pending stories from writers in their organization
        
        **Query Parameters:**
        - `user_id` (required for Editors): User ID for organization-based filtering
      operationId: getPendingStories
      parameters:
        - name: user_id
          in: query
          required: false
          description: User ID for organization-based filtering (required for Editors)
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        '200':
          description: Successfully retrieved pending stories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PendingStoriesResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/pending/count:
    get:
      tags:
        - Stories
      summary: Get count of pending stories
      description: |
        Returns the count of stories awaiting review. Used for notification badges.
        
        **Access:** 
        - Super admin: Sees count of all pending stories
        - Editor: Sees count of pending stories from writers in their organization
        
        **Query Parameters:**
        - `user_id` (required for Editors): User ID for organization-based filtering
      operationId: getPendingStoriesCount
      parameters:
        - name: user_id
          in: query
          required: false
          description: User ID for organization-based filtering (required for Editors)
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        '200':
          description: Successfully retrieved pending count
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PendingCountResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/{id}/approve:
    post:
      tags:
        - Stories
      summary: Approve and publish a story (Super admin only)
      description: |
        Approves a pending story and publishes it. Changes status from `pending` to `published`.
        
        **Access:** Super admin only
        
        **Requirements:**
        - Story must have status `pending`
        - Admin user must have `manage_story_categories` permission
      operationId: approveStory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Story ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApproveStoryRequest'
            example:
              admin_user_id: 1
      responses:
        '200':
          description: Story approved and published successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApproveStoryResponse'
        '400':
          description: Story is not pending approval
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - User doesn't have permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Story not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/{id}/reject:
    post:
      tags:
        - Stories
      summary: Reject a story (Super admin only)
      description: |
        Rejects a pending story. Changes status from `pending` to `rejected`.
        
        **Access:** Super admin only
        
        **Requirements:**
        - Story must have status `pending`
        - Admin user must have `manage_story_categories` permission
      operationId: rejectStory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Story ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RejectStoryRequest'
            example:
              admin_user_id: 1
              rejection_reason: "Content does not meet our editorial guidelines"
      responses:
        '200':
          description: Story rejected successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RejectStoryResponse'
        '400':
          description: Story is not pending approval
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - User doesn't have permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Story not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/writer/{userId}:
    get:
      tags:
        - Stories
      summary: Get stories for a writer (their own stories)
      description: |
        Retrieves all stories submitted by a specific writer.
        
        Returns stories with all statuses (pending, published, rejected) for the writer.
        
        **Note:** "Reader" role has been renamed to "Writer".
      operationId: getWriterStories
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Reader user ID
          example: 2
      responses:
        '200':
          description: Successfully retrieved reader stories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReaderStoriesResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/approved/all:
    get:
      tags:
        - Stories
      summary: Get all approved stories
      description: |
        Retrieves all published stories.
        
        **Access:** 
        - Super admin: Sees all approved stories
        - Editor: Sees only approved stories from writers in their organization
        
        **Query Parameters:**
        - `user_id` (required for Editors): User ID for organization-based filtering
      operationId: getAllApprovedStories
      parameters:
        - name: user_id
          in: query
          required: false
          description: User ID for organization-based filtering (required for Editors)
          schema:
            type: integer
            format: int64
          example: 1
      responses:
        '200':
          description: Successfully retrieved approved stories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovedStoriesResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/approved/{adminId}:
    get:
      tags:
        - Stories
      summary: Get stories approved by an admin
      description: |
        Retrieves all published stories that were approved by a specific admin.
        
        **Access:** 
        - Super admin: Sees all stories approved by any admin
        - Editor: Sees only stories from their organization approved by them
        
        **Note:** Editors can only see stories from writers in their organization.
      operationId: getApprovedStories
      parameters:
        - name: adminId
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Admin user ID
          example: 1
      responses:
        '200':
          description: Successfully retrieved approved stories
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovedStoriesResponse'
        '403':
          description: Forbidden - User doesn't have permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Admin user not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/slug/{slug}:
    get:
      tags:
        - Stories
      summary: Get a single published story by slug (Public)
      description: |
        Retrieves a single published story by its slug. This is a public endpoint and does not require authentication.
        
        Returns the full story details including author, category, and region information.
        
        **Note:** This is the preferred endpoint for retrieving stories by their URL-friendly slug.
      operationId: getPublishedStoryBySlug
      parameters:
        - name: slug
          in: path
          required: true
          schema:
            type: string
          description: Story slug (URL-friendly identifier)
          example: "saving-the-western-ghats-forest"
      responses:
        '200':
          description: Successfully retrieved the story
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetStoryResponse'
              example:
                success: true
                story:
                  id: 1
                  title: "Saving the western ghats forest"
                  slug: "saving-the-western-ghats-forest"
                  content: "A tribal community's fight to protect their ancestral woodland..."
                  status: "published"
                  created_at: "2025-12-01T10:00:00+00:00"
                  published_at: "2025-12-01T12:00:00+00:00"
                  author_name: "John Doe"
                  category_id: 1
                  category_name: "Forest Conservation"
                  region_id: 1
                  region_name: "Maharashtra"
                  region_code: "MH"
        '404':
          description: Published story not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Published story not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/stories/{id}:
    get:
      tags:
        - Stories
      summary: Get a single published story by ID (Public)
      description: |
        Retrieves a single published story by its ID. This is a public endpoint and does not require authentication.
        
        Returns the full story details including author, category, and region information.
        
        **Note:** For better SEO and URL readability, prefer using `/api/stories/slug/{slug}` endpoint.
      operationId: getPublishedStory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Story ID
          example: 1
      responses:
        '200':
          description: Successfully retrieved the story
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GetStoryResponse'
              example:
                success: true
                story:
                  id: 1
                  title: "Saving the western ghats forest"
                  content: "A tribal community's fight to protect their ancestral woodland..."
                  status: "published"
                  created_at: "2025-12-01T10:00:00+00:00"
                  published_at: "2025-12-01T12:00:00+00:00"
                  author_name: "John Doe"
                  category_id: 1
                  category_name: "Forest Conservation"
                  region_id: 1
                  region_name: "Maharashtra"
                  region_code: "MH"
        '404':
          description: Published story not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                success: false
                message: "Published story not found"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    put:
      tags:
        - Stories
      summary: Update a published story (Super admin only)
      description: |
        Updates a published story. Only published stories can be edited.
        
        **Access:** Super admin only
        
        **Requirements:**
        - Story must have status `published`
        - Admin user must have `manage_story_categories` permission
      operationId: updateStory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Story ID
          example: 1
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateStoryRequest'
            example:
              admin_user_id: 1
              title: "Updated story title"
              subtitle: "Updated subtitle"
              photo_url: "https://example.com/images/updated-photo.jpg"
              quote: "Updated quote text"
              person_name: "Updated Person Name"
              person_location: "Updated Location"
              facilitator_name: "Updated Facilitator"
              facilitator_organization: "Updated Organization"
              state: "Karnataka"
              city: "Bangalore"
              content: "Updated story content"
              category_id: 1
      responses:
        '200':
          description: Story updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpdateStoryResponse'
        '400':
          description: Validation error or story is not published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '403':
          description: Forbidden - User doesn't have permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Story not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    delete:
      tags:
        - Stories
      summary: Delete a published story (Super admin only)
      description: |
        Deletes a published story. Only published stories can be deleted.
        
        **Access:** Super admin only
        
        **Requirements:**
        - Story must have status `published`
        - Admin user must have `manage_story_categories` permission
      operationId: deleteStory
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
          description: Story ID
          example: 1
      responses:
        '200':
          description: Story deleted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteStoryResponse'
        '400':
          description: Story is not published
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Forbidden - User doesn't have permission
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Story not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    HealthCheckSuccess:
      type: object
      required:
        - success
        - message
        - user_count
        - database
        - timestamp
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Database connection successful"
        user_count:
          type: integer
          description: Number of users in the database
          example: 2
        database:
          type: string
          description: Database name
          example: "fes_stories"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-12-01T12:00:00+00:00"

    HealthCheckError:
      type: object
      required:
        - success
        - message
        - user_count
        - database
        - timestamp
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Database connection failed: Connection refused"
        user_count:
          type: integer
          example: 0
        database:
          type: string
          example: "fes_stories"
        timestamp:
          type: string
          format: date-time
          example: "2025-12-01T12:00:00+00:00"
        error:
          type: object
          properties:
            code:
              type: integer
              example: 2002
            message:
              type: string
              example: "Connection refused"

    LoginRequest:
      type: object
      required:
        - email
        - password
      properties:
        email:
          type: string
          format: email
          maxLength: 255
          description: User email address
          example: "vyom@example.com"
        password:
          type: string
          minLength: 1
          description: User password (minimum 1 character for development)
          example: "123"
          writeOnly: true

    LoginSuccess:
      type: object
      required:
        - success
        - message
        - user
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Login successful"
        user:
          $ref: '#/components/schemas/UserWithRole'

    OAuthCallbackRequest:
      type: object
      required:
        - code
        - code_verifier
      properties:
        code:
          type: string
          description: Authorization code received from OAuth server
          example: "abc123def456"
        code_verifier:
          type: string
          description: Code verifier used in PKCE flow (must match code_challenge sent to authorization endpoint)
          example: "dBjftJeZ4CVP-mB92K27uhbUJU1p1r_wW1gFWFOEjXk"

    OAuthCallbackSuccess:
      type: object
      required:
        - success
        - message
        - user
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Login successful"
        user:
          $ref: '#/components/schemas/UserWithRole'

    GetCurrentUserSuccess:
      type: object
      required:
        - success
        - user
      properties:
        success:
          type: boolean
          example: true
        user:
          $ref: '#/components/schemas/UserWithRole'

    LogoutSuccess:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Logged out successfully"

    UserWithRole:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: User ID
          example: 1
        email:
          type: string
          format: email
          description: User email address
          example: "vyom@example.com"
        name:
          type: string
          description: User full name
          example: "Vyom"
        role:
          $ref: '#/components/schemas/Role'

    Role:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Role ID
          example: 1
        name:
          type: string
          description: Role name
          example: "Super admin"

    UserListItem:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: User ID
          example: 2
        name:
          type: string
          description: User full name
          example: "John Doe"
        email:
          type: string
          format: email
          description: User email address
          example: "john@example.com"
        role_id:
          type: integer
          format: int64
          description: Role ID
          example: 2
        role_name:
          type: string
          description: Role name (Reader renamed to Writer)
          example: "Writer"
        organization_id:
          type: integer
          format: int64
          nullable: true
          description: Organization ID
          example: 1
        organization_name:
          type: string
          nullable: true
          description: Organization name
          example: "Test ORG 1"
        region_id:
          type: integer
          format: int64
          nullable: true
          description: Region ID (derived from organization)
          example: 1
        region_name:
          type: string
          nullable: true
          description: Region name (derived from organization)
          example: "Maharashtra"
        is_active:
          type: boolean
          description: Whether the user is active
          example: true
        created_at:
          type: string
          format: date-time
          description: User creation timestamp
          example: "2025-12-01T10:00:00+00:00"
        updated_at:
          type: string
          format: date-time
          description: User last update timestamp
          example: "2025-12-01T10:00:00+00:00"

    UserListResponse:
      type: object
      required:
        - success
        - users
      properties:
        success:
          type: boolean
          example: true
        users:
          type: array
          items:
            $ref: '#/components/schemas/UserListItem'

    CreateUserRequest:
      type: object
      required:
        - name
        - email
        - password
        - role_id
        - organization_id
      properties:
        name:
          type: string
          maxLength: 255
          description: User full name
          example: "Jane Doe"
        email:
          type: string
          format: email
          maxLength: 255
          description: User email address (must be unique)
          example: "jane@example.com"
        password:
          type: string
          minLength: 1
          description: User password
          example: "password123"
          writeOnly: true
        role_id:
          type: integer
          format: int64
          description: Role ID (cannot be Super admin)
          example: 2
        organization_id:
          type: integer
          format: int64
          description: Organization ID the user belongs to
          example: 1

    CreateUserResponse:
      type: object
      required:
        - success
        - message
        - user
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "User created successfully"
        user:
          $ref: '#/components/schemas/UserListItem'

    UpdateRoleRequest:
      type: object
      required:
        - name
        - email
        - role_id
        - organization_id
      properties:
        name:
          type: string
          maxLength: 255
          description: User full name
          example: "John Doe"
        email:
          type: string
          format: email
          maxLength: 255
          description: User email address (must be unique, except for current user)
          example: "john@example.com"
        role_id:
          type: integer
          format: int64
          description: New role ID (cannot be Super admin)
          example: 2
        organization_id:
          type: integer
          format: int64
          description: Organization ID the user belongs to
          example: 1

    UpdateRoleResponse:
      type: object
      required:
        - success
        - message
        - user
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "User role updated successfully"
        user:
          $ref: '#/components/schemas/UserListItem'

    DeleteUserResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "User deleted successfully"

    RoleItem:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Role ID
          example: 2
        role_name:
          type: string
          description: Role name
          example: "Writer"

    RoleListResponse:
      type: object
      required:
        - success
        - roles
      properties:
        success:
          type: boolean
          example: true
        roles:
          type: array
          items:
            $ref: '#/components/schemas/RoleItem'

    ErrorResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          description: Error message
          example: "Invalid credentials"

    ValidationError:
      type: object
      required:
        - success
        - message
        - errors
      properties:
        success:
          type: boolean
          example: false
        message:
          type: string
          example: "Validation failed"
        errors:
          type: object
          description: Validation errors grouped by field
          additionalProperties:
            type: array
            items:
              type: string
          example:
            email:
              - "The email must be a valid email address."
            password:
              - "The password field is required."

    StoryCategory:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Category ID
          example: 1
        name:
          type: string
          maxLength: 255
          description: Category name (unique)
          example: "Technology"
        description:
          type: string
          nullable: true
          description: Category description
          example: "Stories about technology and innovation"
        is_active:
          type: boolean
          description: Whether the category is active
          example: true
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when category was created
          example: "2025-12-02T10:30:00+00:00"
        updated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when category was last updated
          example: "2025-12-02T10:30:00+00:00"

    StoryCategoryListResponse:
      type: object
      required:
        - success
        - categories
      properties:
        success:
          type: boolean
          example: true
        categories:
          type: array
          items:
            $ref: '#/components/schemas/StoryCategory'

    CreateStoryCategoryRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 255
          description: Category name (must be unique)
          example: "Technology"
        description:
          type: string
          nullable: true
          description: Category description
          example: "Stories about technology and innovation"
        is_active:
          type: boolean
          description: "Whether the category is active (default: true)"
          example: true

    CreateStoryCategoryResponse:
      type: object
      required:
        - success
        - message
        - category
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story category created successfully"
        category:
          $ref: '#/components/schemas/StoryCategory'

    DeleteStoryCategoryResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story category deleted successfully"

    ReaderWithCategories:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Reader user ID
          example: 2
        name:
          type: string
          description: Reader name
          example: "John Doe"
        email:
          type: string
          format: email
          description: Reader email
          example: "john@example.com"
        categories:
          type: array
          description: Categories accessible by this reader
          items:
            type: object
            properties:
              id:
                type: integer
                format: int64
                example: 1
              name:
                type: string
                example: "Technology"
              description:
                type: string
                nullable: true
                example: "Stories about technology"

    ReadersWithAccessResponse:
      type: object
      required:
        - success
        - readers
      properties:
        success:
          type: boolean
          example: true
        readers:
          type: array
          items:
            $ref: '#/components/schemas/ReaderWithCategories'

    UpdateReaderAccessRequest:
      type: object
      required:
        - category_ids
      properties:
        category_ids:
          type: array
          description: Array of category IDs the reader should have access to
          items:
            type: integer
            format: int64
          example: [1, 2, 3]

    UpdateReaderAccessResponse:
      type: object
      required:
        - success
        - message
        - categories
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Reader access updated successfully"
        categories:
          type: array
          items:
            $ref: '#/components/schemas/StoryCategory'

    Activity:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Activity ID
          example: 1
        type:
          type: string
          maxLength: 50
          description: Activity type (login, create, edit, delete)
          example: "login"
        message:
          type: string
          description: Human-readable activity message
          example: "Logged in as Vyom (vyom@example.com)"
        metadata:
          type: object
          description: Additional activity data in JSON format
          additionalProperties: true
          example:
            userId: 1
            userName: "Vyom"
            userEmail: "vyom@example.com"
            roleName: "Super admin"
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp when activity occurred
          example: "2025-12-02T10:30:00+00:00"

    ActivityListResponse:
      type: object
      required:
        - success
        - activities
      properties:
        success:
          type: boolean
          example: true
        activities:
          type: array
          description: List of activities (max 50, ordered by most recent first)
          items:
            $ref: '#/components/schemas/Activity'

    CreateActivityRequest:
      type: object
      required:
        - user_id
        - type
        - message
      properties:
        user_id:
          type: integer
          format: int64
          description: User ID who performed the activity
          example: 1
        type:
          type: string
          maxLength: 50
          description: Activity type (login, create, edit, delete)
          example: "login"
        message:
          type: string
          description: Human-readable activity message
          example: "Logged in as Vyom (vyom@example.com)"
        metadata:
          type: object
          description: Optional additional activity data in JSON format
          additionalProperties: true
          example:
            userId: 1
            userName: "Vyom"
            userEmail: "vyom@example.com"
            roleName: "Super admin"

    CreateActivityResponse:
      type: object
      required:
        - success
        - message
        - activity
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Activity logged successfully"
        activity:
          $ref: '#/components/schemas/Activity'

    Story:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Story ID
          example: 1
        title:
          type: string
          maxLength: 255
          description: Story title
          example: "Saving the western ghats forest"
        slug:
          type: string
          description: URL-friendly story slug
          example: "saving-the-western-ghats-forest"
        subtitle:
          type: string
          maxLength: 255
          nullable: true
          description: Story subtitle
          example: "A community's fight for conservation"
        photo_url:
          type: string
          maxLength: 500
          nullable: true
          description: URL to story photo
          example: "https://example.com/images/story-photo.jpg"
        quote:
          type: string
          nullable: true
          description: Quote from the story subject
          example: "We must protect our forests for future generations"
        person_name:
          type: string
          maxLength: 255
          nullable: true
          description: Name of the person featured in the story
          example: "Rajesh Kumar"
        person_location:
          type: string
          maxLength: 255
          nullable: true
          description: Location of the person featured in the story
          example: "Mumbai, Maharashtra"
        facilitator_name:
          type: string
          maxLength: 255
          nullable: true
          description: Name of the facilitator
          example: "Dr. Priya Sharma"
        facilitator_organization:
          type: string
          maxLength: 255
          nullable: true
          description: Organization of the facilitator
          example: "FES Foundation"
        state:
          type: string
          maxLength: 255
          nullable: true
          description: State where the story takes place
          example: "Maharashtra"
        city:
          type: string
          maxLength: 255
          nullable: true
          description: City where the story takes place
          example: "Mumbai"
        content:
          type: string
          description: Story content (HTML supported)
          example: "A tribal community's fight to protect their ancestral woodland from commercial logging."
        status:
          type: string
          enum: [draft, pending, approved, published, rejected]
          description: Story status
          example: "published"
        category_id:
          type: integer
          format: int64
          description: Category ID
          example: 1
        category_name:
          type: string
          description: Category name
          example: "Environment"
        author_name:
          type: string
          description: Author name
          example: "John Doe"
        author_email:
          type: string
          format: email
          description: Author email
          example: "john@example.com"
        created_at:
          type: string
          format: date-time
          description: Story creation timestamp
          example: "2025-12-02T10:30:00+00:00"
        published_at:
          type: string
          format: date-time
          nullable: true
          description: Publication timestamp
        region_id:
          type: integer
          format: int64
          nullable: true
          description: Region ID associated with the story's category
          example: 1
        region_name:
          type: string
          nullable: true
          description: Region name (state or union territory) associated with the story's category
          example: "Maharashtra"
        region_code:
          type: string
          nullable: true
          description: Region code (state code) associated with the story's category
          example: "MH"
        approved_at:
          type: string
          format: date-time
          nullable: true
          description: Approval timestamp
          example: "2025-12-02T11:00:00+00:00"
        rejection_reason:
          type: string
          nullable: true
          description: Rejection reason (if rejected)
          example: "Content does not meet editorial guidelines"

    GetStoryResponse:
      type: object
      required:
        - success
        - story
      properties:
        success:
          type: boolean
          example: true
        story:
          $ref: '#/components/schemas/Story'

    PublishedStoriesResponse:
      type: object
      required:
        - success
        - stories
        - count
      properties:
        success:
          type: boolean
          example: true
        stories:
          type: array
          items:
            $ref: '#/components/schemas/Story'
        count:
          type: integer
          description: Total number of published stories
          example: 10

    SubmitStoryRequest:
      type: object
      required:
        - user_id
        - category_id
        - title
        - content
        - state
      properties:
        user_id:
          type: integer
          format: int64
          description: User ID submitting the story
          example: 2
        category_id:
          type: integer
          format: int64
          description: Category ID
          example: 1
        title:
          type: string
          maxLength: 255
          description: Story title
          example: "Saving the western ghats forest"
        subtitle:
          type: string
          maxLength: 255
          nullable: true
          description: Story subtitle (optional)
          example: "A community's fight for conservation"
        photo_url:
          type: string
          maxLength: 500
          nullable: true
          description: URL to story photo (optional)
          example: "https://example.com/images/story-photo.jpg"
        quote:
          type: string
          nullable: true
          description: Quote from the story subject (optional)
          example: "We must protect our forests for future generations"
        person_name:
          type: string
          maxLength: 255
          nullable: true
          description: Name of the person featured in the story (optional)
          example: "Rajesh Kumar"
        person_location:
          type: string
          maxLength: 255
          nullable: true
          description: Location of the person featured in the story (optional)
          example: "Mumbai, Maharashtra"
        facilitator_name:
          type: string
          maxLength: 255
          nullable: true
          description: Name of the facilitator (optional)
          example: "Dr. Priya Sharma"
        facilitator_organization:
          type: string
          maxLength: 255
          nullable: true
          description: Organization of the facilitator (optional)
          example: "FES Foundation"
        state:
          type: string
          maxLength: 255
          description: State where the story takes place (required)
          example: "Maharashtra"
        city:
          type: string
          maxLength: 255
          nullable: true
          description: City where the story takes place (optional)
          example: "Mumbai"
        content:
          type: string
          description: Story content (HTML supported)
          example: "A tribal community's fight to protect their ancestral woodland from commercial logging."

    SubmitStoryResponse:
      type: object
      required:
        - success
        - message
        - story
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story submitted successfully. It will be reviewed by an administrator."
        story:
          $ref: '#/components/schemas/Story'

    PendingStoriesResponse:
      type: object
      required:
        - success
        - stories
        - count
      properties:
        success:
          type: boolean
          example: true
        stories:
          type: array
          items:
            $ref: '#/components/schemas/Story'
        count:
          type: integer
          description: Total number of pending stories
          example: 5

    PendingCountResponse:
      type: object
      required:
        - success
        - count
      properties:
        success:
          type: boolean
          example: true
        count:
          type: integer
          description: Number of pending stories
          example: 5

    ApproveStoryRequest:
      type: object
      required:
        - admin_user_id
      properties:
        admin_user_id:
          type: integer
          format: int64
          description: Admin user ID approving the story
          example: 1

    ApproveStoryResponse:
      type: object
      required:
        - success
        - message
        - story
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story approved and published successfully"
        story:
          $ref: '#/components/schemas/Story'

    RejectStoryRequest:
      type: object
      required:
        - admin_user_id
      properties:
        admin_user_id:
          type: integer
          format: int64
          description: Admin user ID rejecting the story
          example: 1
        rejection_reason:
          type: string
          maxLength: 500
          nullable: true
          description: Optional reason for rejection
          example: "Content does not meet our editorial guidelines"

    RejectStoryResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story rejected successfully"

    ReaderStoriesResponse:
      type: object
      required:
        - success
        - stories
      properties:
        success:
          type: boolean
          example: true
        stories:
          type: array
          items:
            $ref: '#/components/schemas/Story'

    ApprovedStoriesResponse:
      type: object
      required:
        - success
        - stories
      properties:
        success:
          type: boolean
          example: true
        stories:
          type: array
          items:
            $ref: '#/components/schemas/Story'

    UpdateStoryRequest:
      type: object
      required:
        - admin_user_id
      properties:
        admin_user_id:
          type: integer
          format: int64
          description: Admin user ID updating the story
          example: 1
        title:
          type: string
          maxLength: 255
          description: Updated story title (optional)
          example: "Updated story title"
        subtitle:
          type: string
          maxLength: 255
          nullable: true
          description: Updated story subtitle (optional)
          example: "Updated subtitle"
        photo_url:
          type: string
          maxLength: 500
          nullable: true
          description: Updated story photo URL (optional)
          example: "https://example.com/images/updated-photo.jpg"
        quote:
          type: string
          nullable: true
          description: Updated quote (optional)
          example: "Updated quote text"
        person_name:
          type: string
          maxLength: 255
          nullable: true
          description: Updated person name (optional)
          example: "Updated Person Name"
        person_location:
          type: string
          maxLength: 255
          nullable: true
          description: Updated person location (optional)
          example: "Updated Location"
        facilitator_name:
          type: string
          maxLength: 255
          nullable: true
          description: Updated facilitator name (optional)
          example: "Updated Facilitator"
        facilitator_organization:
          type: string
          maxLength: 255
          nullable: true
          description: Updated facilitator organization (optional)
          example: "Updated Organization"
        state:
          type: string
          maxLength: 255
          description: Updated state (optional, but required if provided)
          example: "Karnataka"
        city:
          type: string
          maxLength: 255
          nullable: true
          description: Updated city (optional)
          example: "Bangalore"
        content:
          type: string
          description: Updated story content (optional, HTML supported)
          example: "Updated story content"
        category_id:
          type: integer
          format: int64
          description: Updated category ID (optional)
          example: 1

    UpdateStoryResponse:
      type: object
      required:
        - success
        - message
        - story
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story updated successfully"
        story:
          $ref: '#/components/schemas/Story'

    DeleteStoryResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Story deleted successfully"

    Region:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Region ID
          example: 1
        name:
          type: string
          maxLength: 100
          description: Region name (state or union territory)
          example: "Andhra Pradesh"
        code:
          type: string
          maxLength: 10
          nullable: true
          description: Region code (state code)
          example: "AP"
        is_active:
          type: boolean
          description: Whether the region is active
          example: true
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when region was created
          example: "2025-12-02T10:00:00+00:00"
        updated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when region was last updated
          example: "2025-12-02T10:00:00+00:00"

    RegionListResponse:
      type: object
      required:
        - success
        - regions
      properties:
        success:
          type: boolean
          example: true
        regions:
          type: array
          items:
            $ref: '#/components/schemas/Region'

    ToggleUserStatusResponse:
      type: object
      required:
        - success
        - message
        - user
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "User status updated successfully"
        user:
          type: object
          properties:
            id:
              type: integer
              format: int64
              example: 2
            name:
              type: string
              example: "John Doe"
            email:
              type: string
              format: email
              example: "john@example.com"
            role_id:
              type: integer
              format: int64
              example: 2
            role_name:
              type: string
              example: "Writer"
            region_id:
              type: integer
              format: int64
              nullable: true
              example: 1
            region_name:
              type: string
              nullable: true
              example: "Maharashtra"
            is_active:
              type: boolean
              example: false
            created_at:
              type: string
              format: date-time
              example: "2025-12-01T10:00:00+00:00"
            updated_at:
              type: string
              format: date-time
              example: "2025-12-02T12:00:00+00:00"

    ToggleCategoryStatusResponse:
      type: object
      required:
        - success
        - message
        - category
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Category status updated successfully"
        category:
          $ref: '#/components/schemas/StoryCategory'

    Organization:
      type: object
      properties:
        id:
          type: integer
          format: int64
          description: Organization ID
          example: 1
        name:
          type: string
          maxLength: 255
          description: Organization name
          example: "Test ORG 1"
        region_id:
          type: integer
          format: int64
          nullable: true
          description: Region ID
          example: 1
        region_name:
          type: string
          nullable: true
          description: Region name
          example: "Maharashtra"
        is_active:
          type: boolean
          description: Whether the organization is active
          example: true
        created_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when organization was created
          example: "2025-12-02T10:00:00+00:00"
        updated_at:
          type: string
          format: date-time
          description: ISO 8601 timestamp when organization was last updated
          example: "2025-12-02T10:00:00+00:00"

    OrganizationListResponse:
      type: object
      required:
        - success
        - organizations
      properties:
        success:
          type: boolean
          example: true
        organizations:
          type: array
          items:
            $ref: '#/components/schemas/Organization'

    CreateOrganizationRequest:
      type: object
      required:
        - name
      properties:
        name:
          type: string
          maxLength: 255
          description: Organization name
          example: "Test ORG 1"
        region_id:
          type: integer
          format: int64
          nullable: true
          description: Region ID
          example: 1
        is_active:
          type: boolean
          description: "Whether the organization is active (default: true)"
          example: true

    CreateOrganizationResponse:
      type: object
      required:
        - success
        - message
        - organization
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Organization created successfully"
        organization:
          $ref: '#/components/schemas/Organization'

    DeleteOrganizationResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Organization deleted successfully"

    ToggleOrganizationStatusResponse:
      type: object
      required:
        - success
        - message
        - organization
      properties:
        success:
          type: boolean
          example: true
        message:
          type: string
          example: "Organization status updated successfully"
        organization:
          $ref: '#/components/schemas/Organization'

  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: session_id
      description: |
        HTTP-only session cookie containing the session ID.
        
        **How it works:**
        1. After successful OAuth login via `/api/auth/oauth/callback`, the server sets an HTTP-only cookie named `session_id`
        2. This cookie is automatically sent with all subsequent requests to the same domain
        3. The server validates the session_id against the sessions table
        4. If valid, the request is authenticated; if invalid or expired, returns 401 Unauthorized
        
        **Security:**
        - Cookie is HTTP-only (not accessible via JavaScript)
        - Cookie is SameSite=Lax (CSRF protection)
        - Session tokens are encrypted in database
        - Sessions expire automatically based on token expiration

